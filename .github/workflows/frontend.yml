name: Deploy CRT Application

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout Repository
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Setup Node 20 + npm cache
    - name: Setup Node 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    # 3Ô∏è‚É£ Cache node_modules + Next.js build cache ‚Üí big speed up
    - name: Cache Dependencies & Build
      uses: actions/cache@v3
      with:
        path: |
          node_modules
          .next/cache
          ~/.npm
        key: ${{ runner.os }}-crt-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-crt-

    # 4Ô∏è‚É£ Install dependencies (fast & clean)
    - name: Install Dependencies
      run: npm ci

    # 5Ô∏è‚É£ Build Next.js on GitHub (NOT on server) ‚Üí fastest deploy
    - name: Build Next.js
      run: npm run build

    # 6Ô∏è‚É£ Prepare artifacts to deploy
    - name: Prepare deploy artifacts
      run: |
        mkdir -p deploy-dist
        cp -r .next public package.json deploy-dist/

    # 7Ô∏è‚É£ Setup SSH Keys
    - name: Setup SSH Keys
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    # 8Ô∏è‚É£ Deploy Frontend Build only (no npm install or build on server)
    - name: Deploy Frontend to Server
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/crt-app/frontend"
        scp -i ~/.ssh/id_rsa -r deploy-dist/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/crt-app/frontend/

    # 9Ô∏è‚É£ Start/Reload Frontend via PM2
    - name: Start Frontend (PM2)
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          npm install --production || true
          pm2 reload crt-frontend --update-env || pm2 start ~/crt-app/frontend/node_modules/.bin/next -- start -p 3000 --name crt-frontend
          pm2 save
        "

    # üîü Deploy Backend via PM2 safely
    - name: Start Backend (PM2)
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          pm2 reload backend --update-env || pm2 start uvicorn --name backend -- main:app --host 0.0.0.0 --port 8000
          pm2 save
        "

    # 1Ô∏è‚É£1Ô∏è‚É£ Generate & Deploy NGINX reverse proxy config
    - name: Generate & Deploy NGINX Config
      run: |
        echo "
        server {
            listen 80;
            server_name _;
            location / {
                proxy_pass http://127.0.0.1:3000;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
            }
            location /api/ {
                proxy_pass http://127.0.0.1:8000/;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
            }
        }
        " > crt.conf

        scp -i ~/.ssh/id_rsa crt.conf ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/crt.conf
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          sudo mv /tmp/crt.conf /etc/nginx/sites-available/crt.conf &&
          sudo ln -sf /etc/nginx/sites-available/crt.conf /etc/nginx/sites-enabled/crt.conf &&
          sudo nginx -t &&
          sudo systemctl restart nginx
        "

    # 1Ô∏è‚É£2Ô∏è‚É£ Verify PM2 services
    - name: Verify PM2 Services
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "pm2 status"
