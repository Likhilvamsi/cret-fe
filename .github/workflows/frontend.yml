name: Deploy CRT Frontend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout Repository
      uses: actions/checkout@v3

    # 2ï¸âƒ£ Setup Node 20 on runner & enable yarn/npm build
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    # 3ï¸âƒ£ Cache npm + Next.js build cache (reduces build time)
    - name: Cache build outputs
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          .next/cache
        key: ${{ runner.os }}-crt-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-crt-

    # 4ï¸âƒ£ Install dependencies
    - name: Install Dependencies
      run: npm ci

    # 5ï¸âƒ£ Build frontend
    - name: Build Next.js App
      run: npm run build

    # 6ï¸âƒ£ Prepare built deployment folder
    - name: Prepare Deployment Files
      run: |
        mkdir -p deploy-dist
        cp -r .next public package.json package-lock.json deploy-dist/

    # 7ï¸âƒ£ Setup SSH
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

    # 8ï¸âƒ£ Upload built files to server (fast deploy)
    - name: Upload Build to Server
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/crt-app/frontend"
        scp -i ~/.ssh/id_rsa -r deploy-dist/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/crt-app/frontend/

    # 9ï¸âƒ£ Install PM2 & restart app
    - name: Restart Frontend App
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          if ! command -v pm2 >/dev/null 2>&1; then
            sudo npm install -g pm2
          fi
          cd ~/crt-app/frontend
          pm2 reload crt-frontend 2>/dev/null || pm2 start 'npm run start' --name crt-frontend
          pm2 save
        "

    # ðŸ”Ÿ Install NGINX once if missing
    - name: Ensure NGINX Installed
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          if ! command -v nginx >/dev/null 2>&1; then
            sudo apt update && sudo apt install -y nginx
            sudo systemctl enable nginx && sudo systemctl start nginx
          fi
        "

    # 1ï¸âƒ£1ï¸âƒ£ Upload NGINX config
    - name: Upload NGINX Config
      run: |
        scp -i ~/.ssh/id_rsa deploy/nginx.conf ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/crt.conf

    # 1ï¸âƒ£2ï¸âƒ£ Apply NGINX Config & restart
    - name: Apply NGINX Configuration
      run: |
        ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          sudo mv /tmp/crt.conf /etc/nginx/sites-available/crt.conf
          sudo ln -sf /etc/nginx/sites-available/crt.conf /etc/nginx/sites-enabled/crt.conf
          sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          sudo nginx -t && sudo systemctl restart nginx
        "
